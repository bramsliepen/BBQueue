<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBQueue Viewer</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h2>Synced Traffic Light Viewer</h2>
    <div id="traffic-light" class="go"></div>
    <div id="message-container">
        <h1 id="message">Loading...</h1>
    </div>
    <!-- <p style="text-align: center; color: gray; font-size: 0.9em;">
        Polling for updates every 3 seconds...
    </p> -->
    <button onclick="pollStatus()" style="padding: 10px 20px; margin-top: 20px; cursor: pointer;">
        Refresh Status
    </button>

    <script>
        const trafficLight = document.getElementById('traffic-light');
        const message = document.getElementById('message');

        // ===== GITHUB GIST POLLING SETUP =====
        // Replace with your Gist ID
        const GIST_ID = '1f434826b262912d9b2154f29b800b53';
        const GIST_RAW_URL = `https://gist.githubusercontent.com/bramsliepen/${GIST_ID}/raw`;

        let lastSyncedState = null;

        async function pollStatus() {
            console.log('Polling status from Gist...');
            try {
                const res = await fetch(GIST_RAW_URL, { cache: 'no-store' });
                if (!res.ok) {
                    message.innerText = 'Error fetching status';
                    return;
                }
                const state = await res.json();
                const currentState = JSON.stringify(state);

                console.log('Fetched state:', state);
                console,log('Current state string:', currentState);

                if (currentState !== lastSyncedState) {
                    lastSyncedState = currentState;

                    // Update traffic light color
                    if (state.trafficLight && state.trafficLight !== trafficLight.style.backgroundColor) {
                        trafficLight.style.backgroundColor = state.trafficLight;
                    }

                    // Update message text
                    if (state.messageText) {
                        message.innerText = state.messageText;
                    }
                }
            } catch (err) {
                console.warn('Poll failed:', err);
                message.innerText = 'Connection lost...';
            }
        }

        // Poll every 5 seconds
        // setInterval(pollStatus, 5000);

        // Poll immediately on load
        (async () => {
            await pollStatus(); // poll once on load
        })();
    </script>
</body>

</html>